---
title: EchoScript for Map Mock
description: Learning EchoScript to modify HTTP(s) request/response
---

import { Image } from 'astro:assets';
import MaterialSymbolsMapOutline from '~icons/material-symbols/map-outline';
import { inlineIcon } from "../../../styles/styles.ts"
import echoScriptImage from '../../../assets/map-echoscript.png';
import logEnvImage from '../../../assets/map-log-env.png';

**EchoScript** is the core of Map Mock. It can work with both Map Local and Map Remote.

<Image src={echoScriptImage} style="border-radius:3px;" alt="EchoScript" />

By default, EchoScript code is commented out, which means it does nothing.
```go
// on_request := func(env, req) {
//   return {}
// }

// on_response := func(env, res) {
//   return {}
// }
```

## Callback functions
EchoScript has two standard callback functions: on_request and on_response,
which can be used to modify HTTP(s) request and response respectively.

### on_request
The return value of **`on_request`** is a **`map`**, which tells EchoProxy how to modify HTTP(s) request.
Return an empty map **`{}`** means it does nothing.

```go
on_request := func(env, req) {
  return {}
}
```

:::note
**`on_request`** is called when EchoProxy receives a new HTTP(s) request from client.
:::

The structure of on_request **`return`** value. All fields are optional.
```json
{
  // change request method, value can be GET/POST/PUT ...
  method: string,
  // change request URL
  url: string,
  // change request URL query parameters, merge with original map
  query: map,
  // change request header key/value pairs, merge with original map
  header: map,
  // change request cookie key/value pairs, merge with original map
  cookie: map,
  // change request body: a string, file, or map
  body: string|file|map
}
```

### on_response
The return value of **`on_response`** is a **`map`**, which tells EchoProxy how to modify HTTP(s) response.
Return an empty map **`{}`** means it does nothing.

```go
on_response := func(env, res) {
  return {}
}
```

:::note
**`on_response`** is called when EchoProxy has received the response of HTTP(s) remote request (MapRemote),
or has loaded the response from local file (MapLocal).
:::

The structure of on_response **`return`** value. All fields are optional.
```json
{
  // change response HTTP status code, value can be 200/302/404 ...
  code: int,
  // change response header key/value pairs, merge with original map
  header: map,
  // change response cookie key/value pairs, merge with original map
  cookie: map,
  // change response body: a string, file, or map
  body: string|file|map
}
```

## Function arguments
### req
The argument **`req`** represents the incoming HTTP **request**. The structure of **`req`**:
```json
{
  u: array,         // holds Wildcard/Regex submatch strings
  url: string,      // request URL
  method: string,   // request method
  query: map,       // request URL query parameters (string)
  header: map,      // request header key/value pairs (string)
  cookie: map,      // request cookie key/value pairs (string)
  body: string|map, // request body: a string or map
  text: string      // request body as text string

  client_ip: string,   // client IP
  client_addr: string, // client address
}
```

:::note
Don't update the value of **`req`**. The updated value will be **discarded**.
:::

### res
The argument **`res`** represents the **response** got from remote HTTP request (MapRemote),
or the **response** loaded from local file (MapLocal). The structure of **`res`**:
```json
{
  code: int,        // response HTTP status code
  header: map,      // response header key/value pairs (string)
  cookie: map,      // response cookie key/value pairs (string)
  body: string|map, // response body: a string or map
  text: string      // response body as text string
}
```

:::note
Don't update the value of **`res`**. The updated value will be **discarded**.
:::

### env
The argument **`env`** is a **`map`**, which is designed to get and set enviroment variables.  
**TODO**: under development

:::note
You can **pass variables** between callback functions using **env**.
:::

**Example**: **Pass variable** `env.key1` from `on_request` to `on_response`, and `print` its value to **Log tab**.
```go
on_request := func(env, req) {
  env["key1"] = { "n": 99, "msg": "Hi" }
  return {}
}

on_response := func(env, res) {
  print("env.key1: ", env.key1)
  return {}
}
```

<Image src={logEnvImage} style="border-radius:3px;" alt="Log env" />
